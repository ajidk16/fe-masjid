<script lang="ts">
	import { page } from '$app/state';
	import { Modal } from '$lib/shared/index.js';
	import { resultStore } from '$lib/store/form-result.js';
	import { Prayers, type Prayer } from '$lib/utils/prayers.js';
	import { onMount } from 'svelte';
	import { writable, derived, get } from 'svelte/store';

	type EventCategory = 'Pengajian' | 'Sosial' | 'Remaja' | 'Umum';

	interface Event {
		date: string; // 'YYYY-MM-DD'
		startAt: string; // 'HH:MM'
		title: string;
		category: EventCategory;
		location: string;
	}

	const categories = $derived(page.data.categories);

	const jadwal = $derived(page.data.jadwal);
	let prayers: Prayer[] = $state([]);

	const loadPrayers = async () => {
		const result = await Prayers(jadwal);
		prayers = result.prayers;
	};

	onMount(() => {
		loadPrayers();
	});

	let modal = $state(false);

	const monthNames = [
		'Januari',
		'Februari',
		'Maret',
		'April',
		'Mei',
		'Juni',
		'Juli',
		'Agustus',
		'September',
		'Oktober',
		'November',
		'Desember'
	] as const;

	const year = writable(2023);
	const month = writable(10); // November (0-indexed)

	const events = writable<Event[]>(page.data.events.data);

	console.log('test error', $resultStore);

	// Utility fungsi format tanggal YYYY-MM-DD
	function fmt(date: Date) {
		return date.toISOString().slice(0, 10);
	}

	// Badge CSS berdasarkan kategori
	function badgeByCat(category: EventCategory) {
		switch (category) {
			case 'Pengajian':
				return 'bg-brand-50 text-brand-900';
			case 'Sosial':
				return 'bg-gold-100 text-gold-900';
			case 'Remaja':
				return 'bg-slate-100 dark:bg-slate-800';
			default:
				return 'bg-slate-100 dark:bg-slate-800';
		}
	}

	// Store tanggal dan bulan sekarang
	const today = new Date();
	let selectedDate = writable(fmt(today));
	year.set(today.getFullYear());
	month.set(today.getMonth());

	// Kalkulasi grid kalender setiap ubah tahun/bulan
	const calendarCells = derived([year, month], ([$year, $month]) => {
		const firstDay = new Date($year, $month, 1);
		const lastDay = new Date($year, $month + 1, 0);
		// Senin sebagai hari pertama (0)
		const startDay = (firstDay.getDay() + 6) % 7;
		const daysInPrevMonth = new Date($year, $month, 0).getDate();
		const totalCells = 42;
		const cells = [];

		for (let i = 0; i < totalCells; i++) {
			let dayNum: number;
			let inMonth = true;
			let dateObj: Date;
			if (i < startDay) {
				dayNum = daysInPrevMonth - (startDay - 1 - i);
				inMonth = false;
				dateObj = new Date($year, $month - 1, dayNum);
			} else if (i < startDay + lastDay.getDate()) {
				dayNum = i - startDay + 1;
				dateObj = new Date($year, $month, dayNum);
			} else {
				dayNum = i - (startDay + lastDay.getDate()) + 1;
				inMonth = false;
				dateObj = new Date($year, $month + 1, dayNum);
			}
			cells.push({ dayNum, inMonth, dateISO: fmt(dateObj) });
		}
		return cells;
	});

	// Events pada tanggal yang dipilih
	const eventsOnSelectedDate = derived([events, selectedDate], ([$events, $selectedDate]) =>
		$events.filter((e) => e.date === $selectedDate)
	);

	// Event mendatang: 8 event terdekat dari hari ini dan sesudahnya
	const upcomingEvents = derived(events, ($events) => {
		const now = new Date();
		const todayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
		return $events
			.map((e) => ({ ...e, d: new Date(e.date + 'T' + (e.startAt || '00:00')) }))
			.filter((e) => e.d >= todayDate)
			.sort((a, b) => a.d.getTime() - b.d.getTime())
			.slice(0, 8);
	});

	// Format tampilan tanggal di UI
	function formatDate(iso: string) {
		const [y, m, d] = iso.split('-').map(Number);
		return `${d} ${monthNames[m - 1]} ${y}`;
	}

	// Pengaturan bulan sebelumnya
	function prevMonth() {
		month.update((m) => {
			if (m === 0) {
				year.update((y) => y - 1);
				return 11;
			}
			return m - 1;
		});
	}

	// Pengaturan bulan berikutnya
	function nextMonth() {
		month.update((m) => {
			if (m === 11) {
				year.update((y) => y + 1);
				return 0;
			}
			return m + 1;
		});
	}

	// Seleksi tanggal dari kalender
	function selectDate(dateISO: string) {
		selectedDate.set(dateISO);
		setTimeout(() => {
			document.getElementById('todayList')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
		}, 100);
	}
</script>

<main class="space-y-6 p-4 lg:p-6">
	<!-- Header dan navigasi bulan -->
	<section
		class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"
	>
		<div class="flex flex-wrap items-center gap-3">
			<!-- <div class="inline-flex rounded-xl border border-slate-200 p-0.5 dark:border-slate-800">
				<button class="view-btn rounded-lg bg-slate-100 px-3 py-1.5 text-sm dark:bg-slate-800"
					>Hari</button
				>
				<button class="view-btn rounded-lg px-3 py-1.5 text-sm">Minggu</button>
				<button class="view-btn rounded-lg px-3 py-1.5 text-sm">Bulan</button>
			</div> -->
			<select
				class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900"
			>
				<option value="">Semua Kategori</option>
				<option>Pengajian</option>
				<option>Sosial</option>
				<option>Remaja</option>
				<option>Umum</option>
			</select>
			<select
				class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900"
			>
				<option value="">Semua Lokasi</option>
				<option>Offline</option>
				<option>Online</option>
			</select>
			<input
				type="date"
				class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm dark:border-slate-800 dark:bg-slate-900"
			/>
			<button class="rounded-xl bg-slate-100 px-3 py-2 text-sm dark:bg-slate-800">Reset</button>
			<div class="ml-auto flex items-center gap-2">
				<button
					onclick={prevMonth}
					class="rounded-xl bg-slate-100 px-3 py-2 text-sm dark:bg-slate-800">Sebelumnya</button
				>
				<div class="text-sm font-medium">{monthNames[$month]} {$year}</div>
				<button
					onclick={nextMonth}
					class="rounded-xl bg-slate-100 px-3 py-2 text-sm dark:bg-slate-800">Berikutnya</button
				>
			</div>
		</div>
	</section>

	<!-- Kalender dan daftar kegiatan mendatang -->
	<section class="grid gap-4 xl:grid-cols-3">
		<div
			class="rounded-2xl border border-slate-200 bg-white p-4 xl:col-span-2 dark:border-slate-800 dark:bg-slate-900"
		>
			<div class="grid grid-cols-7 text-xs font-medium text-slate-500">
				<div class="p-2 text-center">Min</div>
				<div class="p-2 text-center">Sen</div>
				<div class="p-2 text-center">Sel</div>
				<div class="p-2 text-center">Rab</div>
				<div class="p-2 text-center">Kam</div>
				<div class="p-2 text-center">Jum</div>
				<div class="p-2 text-center">Sab</div>
			</div>
			<div class="mt-1 grid grid-cols-7 gap-1 text-sm">
				{#each $calendarCells as { dayNum, inMonth, dateISO }}
					<button
						onclick={() => selectDate(dateISO)}
						class={`group relative h-24 rounded-xl border p-2 text-left align-top
              ${
								inMonth
									? 'border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900'
									: 'border-dashed border-slate-200/60 bg-slate-50/40 dark:border-slate-800/60 dark:bg-slate-950/30'
							}
              hover:ring-2 hover:ring-brand-300 dark:hover:ring-brand-700`}
					>
						<div class="flex items-center justify-between">
							<span class={`text-xs ${inMonth ? '' : 'text-slate-400'}`}>{dayNum}</span>
							{#if dateISO === $selectedDate}
								<span
									class="inline-flex size-5 items-center justify-center rounded-full bg-brand-600 text-[10px] text-white"
									>Now</span
								>
							{/if}
						</div>
						<div class="mt-1 space-y-1 overflow-hidden">
							{#each $events.filter((e) => e.date === dateISO).slice(0, 3) as e}
								<div class={`truncate rounded-lg px-2 py-1 text-[11px] ${badgeByCat(e.category)}`}>
									{e.startAt} &bull; {e.title}
								</div>
							{/each}
							{#if $events.filter((e) => e.date === dateISO).length > 3}
								<div class="text-[10px] text-slate-500">
									+{$events.filter((e) => e.date === dateISO).length - 3} lainnya
								</div>
							{/if}
						</div>
					</button>
				{/each}
			</div>
			<p class="mt-3 text-xs text-slate-500">Kliktanggal untuk melihat kegiatan.</p>
		</div>

		<div
			class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"
		>
			<div class="flex items-center justify-between">
				<p class="font-medium">KegiatanMendatang</p>
				<button class="rounded-lg bg-slate-100 px-3 py-1.5 text-sm dark:bg-slate-800"
					>LihatSemua</button
				>
			</div>
			<ol class="thin-scrollbar mt-4 max-h-[28rem] space-y-4 overflow-auto text-sm">
				{#each $upcomingEvents as event}
					<li class="flex gap-3">
						<span class={`grid size-9 place-items-center rounded-xl ${badgeByCat(event.category)}`}>
							{event.startAt.split(':')[0]}<span class="text-[10px]"
								>:{event.startAt.split(':')[1]}</span
							>
						</span>
						<div>
							<p class="font-medium">{event.title}</p>
							<p class="text-slate-500">{event.category} &bull; {event.location}</p>
							<p class="text-xs text-slate-500">{formatDate(event.date)}</p>
						</div>
					</li>
				{/each}
			</ol>
		</div>
	</section>

	<!-- Agenda hari ini dan pengingat -->
	<section class="grid gap-4 lg:grid-cols-3">
		<div
			class="rounded-2xl border border-slate-200 bg-white lg:col-span-2 dark:border-slate-800 dark:bg-slate-900"
		>
			<div
				class="flex items-center justify-between border-b border-slate-200 p-4 dark:border-slate-800"
			>
				<p class="font-medium">Agenda Hari Ini</p>
				<span class="rounded-lg bg-brand-50 px-2 py-1 text-xs text-brand-900"
					>{$eventsOnSelectedDate.length} kegiatan</span
				>
			</div>
			<div id="todayList" class="space-y-3 p-4 text-sm">
				{#if $eventsOnSelectedDate.length === 0}
					<p class="text-slate-500">Tidakada kegiatan hari ini.</p>
				{:else}
					{#each $eventsOnSelectedDate as e}
						<div
							class="flex items-start gap-3 rounded-xl border border-slate-200 p-3 dark:border-slate-800"
						>
							<div class={`grid size-9 place-items-center rounded-xl ${badgeByCat(e.category)}`}>
								{e.startAt.split(':')[0]}<span class="text-[10px]">:{e.startAt.split(':')[1]}</span>
							</div>
							<div class="flex-1">
								<p class="font-medium">{e.title}</p>
								<p class="text-xs text-slate-500">{e.category} &bull; {e.location}</p>
							</div>
							<button
								onclick={() => (modal = true)}
								class="rounded-lg bg-slate-100 px-2 py-1 text-xs dark:bg-slate-800">Detail</button
							>
						</div>
					{/each}
				{/if}
			</div>
		</div>

		<div
			class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900"
		>
			<p class="font-medium">Pengingat Shalat</p>
			<div class="grid grid-cols-3 gap-2 text-center">
				{#each prayers as prayer}
					<div class="rounded-xl border border-slate-200 p-3 dark:border-slate-800">
						<p class="text-xs text-slate-500">{prayer.name}</p>
						<p class="font-semibold" id={prayer.name.toLowerCase()}>{prayer.time}</p>
					</div>
				{/each}
			</div>

			<div class="pt-2">
				<p class="font-medium">Aksi Cepat</p>
				<button
					class="mt-2 w-full rounded-xl bg-gold-500 px-4 py-2 text-white hover:bg-gold-600"
					onclick={() => (modal = true)}>Tambah Kegiatan</button
				>
				<button class="mt-2 w-full rounded-xl bg-slate-100 px-4 py-2 dark:bg-slate-800"
					>Export iCal</button
				>
			</div>
		</div>
	</section>
</main>

{#if modal}
	<Modal
		isOpen={modal}
		title="Tambah Kegiatan"
		onClose={() => {
			modal = false;
			resultStore.set(null);
		}}
		action="?/createEvent"
	>
		<input type="hidden" name="id" value="id" />
		<input type="hidden" name="mosqueId" value="eb28f270-d11d-418f-91bd-822321f2aa37" />
		<div class="mt-3 grid gap-3 sm:grid-cols-2">
			<div>
				<label for="title" class="text-xs text-slate-500">Judul</label>
				<input
					id="title"
					name="title"
					class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
					placeholder="Masukkan judul"
					value="Kajian Malam Sabtu"
				/>
				<!-- apabila error muncul pesan -->
				{#if $resultStore?.data?.field === '/title'}
					<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
				{/if}
			</div>
			<div>
				<label for="categoryId" class="text-xs text-slate-500">Kategori</label>
				<select
					id="categoryId"
					name="categoryId"
					class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
				>
					{#each categories.data as category}
						<option value={category.id}>{category.name}</option>
					{/each}
				</select>
				{#if $resultStore?.data?.field === '/categoryId'}
					<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
				{/if}
			</div>
			<div>
				<label for="date" class="text-xs text-slate-500">Tanggal</label>
				<input
					id="date"
					name="date"
					type="date"
					value={$selectedDate}
					class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
				/>
				{#if $resultStore?.data?.field === '/date'}
					<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
				{/if}
			</div>
			<div class="grid grid-cols-2 gap-2">
				<div>
					<label for="startAt" class="text-xs text-slate-500">Mulai</label>
					<input
						id="startAt"
						name="startAt"
						type="startAt"
						class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
					/>
					{#if $resultStore?.data?.field === '/startAt'}
						<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
					{/if}
				</div>
				<div>
					<label for="endAt" class="text-xs text-slate-500">Selesai</label>
					<input
						id="endAt"
						name="endAt"
						type="startAt"
						class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
					/>
					{#if $resultStore?.data?.field === '/endAt'}
						<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
					{/if}
				</div>
			</div>
			<div>
				<label for="location" class="text-xs text-slate-500">Lokasi</label>
				<input
					id="location"
					name="location"
					class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
					placeholder="Aula Utama / Zoom"
					value="aula bogor"
				/>
				{#if $resultStore?.data?.field === '/location'}
					<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
				{/if}
			</div>
			<div>
				<label for="speaker" class="text-xs text-slate-500">Pemateri/Koordinator</label>
				<input
					id="speaker"
					name="speaker"
					class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
					placeholder="Ust. Ahmad / Tim Sosial"
					value="zakir naik"
				/>
				{#if $resultStore?.data?.field === '/speaker'}
					<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
				{/if}
			</div>
			<div class="sm:col-span-2">
				<label for="description" class="text-xs text-slate-500">Deskripsi</label>
				<textarea
					id="description"
					name="description"
					class="mt-1 h-24 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 dark:border-slate-800 dark:bg-slate-900"
					placeholder="Ringkasan materi atau kebutuhan acara">testing</textarea
				>
				{#if $resultStore?.data?.field === '/description'}
					<p class="mt-1 text-xs text-red-500">{$resultStore?.data?.message}</p>
				{/if}
			</div>
		</div>
	</Modal>
{/if}
